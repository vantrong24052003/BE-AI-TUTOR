# BE AI TUTOR - AI Chat Flow

> Chi tiáº¿t tÃ­ch há»£p AI Chat trong há»‡ thá»‘ng

---

## ğŸ¤– AI Integration Overview

### AI Provider

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AI PROVIDER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Primary: Claude API (Anthropic)                               â”‚
â”‚  â”œâ”€â”€ Model: claude-3-sonnet / claude-3-haiku                   â”‚
â”‚  â”œâ”€â”€ Context: 200K tokens                                      â”‚
â”‚  â””â”€â”€ Best for: Educational content, tutoring                   â”‚
â”‚                                                                 â”‚
â”‚  Fallback: OpenAI GPT-4                                        â”‚
â”‚  â”œâ”€â”€ Model: gpt-4-turbo                                        â”‚
â”‚  â”œâ”€â”€ Context: 128K tokens                                      â”‚
â”‚  â””â”€â”€ Best for: General assistance                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¬ Chat Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CHAT ARCHITECTURE                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Client   â”‚â”€â”€â”€â”€â”€â–¶â”‚   API     â”‚â”€â”€â”€â”€â”€â–¶â”‚  Service  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Claude APIâ”‚
  â”‚  Request  â”‚      â”‚  Layer    â”‚      â”‚  Layer    â”‚      â”‚           â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                   â”‚
                            â”‚                   â”‚
                            â–¼                   â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   Redis   â”‚      â”‚ Database  â”‚
                     â”‚   Cache   â”‚      â”‚  Storage  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Chat Flow

### 1. Create Conversation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Select  â”‚â”€â”€â”€â”€â–¶â”‚ Create  â”‚â”€â”€â”€â”€â–¶â”‚  Build  â”‚â”€â”€â”€â”€â–¶â”‚ Return  â”‚
â”‚ Course  â”‚     â”‚  Conv   â”‚     â”‚ Context â”‚     â”‚  Conv   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Send Message

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚â”€â”€â”€â”€â–¶â”‚  Check  â”‚â”€â”€â”€â”€â–¶â”‚  Build  â”‚â”€â”€â”€â”€â–¶â”‚  Call   â”‚â”€â”€â”€â”€â–¶â”‚  Save   â”‚
â”‚ Message â”‚     â”‚  Rate   â”‚     â”‚ Prompt  â”‚     â”‚   AI    â”‚     â”‚Response â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Prompt Engineering

### System Prompt Template

```
Báº¡n lÃ  má»™t AI Tutor thÃ´ng minh vÃ  thÃ¢n thiá»‡n, giÃºp há»c viÃªn há»c táº­p hiá»‡u quáº£.

THÃ”NG TIN KHÃ“A Há»ŒC:
- TÃªn: {course_title}
- MÃ´ táº£: {course_description}
- Cáº¥p Ä‘á»™: {course_level}

HÆ¯á»šNG DáºªN:
1. Tráº£ lá»i ngáº¯n gá»n, dá»… hiá»ƒu
2. Sá»­ dá»¥ng vÃ­ dá»¥ thá»±c táº¿
3. Khuyáº¿n khÃ­ch há»c viÃªn suy nghÄ©
4. Äá» xuáº¥t tÃ i liá»‡u bá»• sung khi phÃ¹ há»£p
5. Náº¿u cÃ¢u há»i ngoÃ i pháº¡m vi, hÃ£y hÆ°á»›ng dáº«n há»c viÃªn lá»‹ch sá»±

PHONG CÃCH:
- ThÃ¢n thiá»‡n, Ä‘á»™ng viÃªn
- Sá»­ dá»¥ng emoji phÃ¹ há»£p
- Äá»‹nh dáº¡ng code náº¿u cÃ³
```

### Context Building

```python
def build_context(conversation_id: int, course_id: int):
    context = {
        "course": get_course(course_id),
        "recent_messages": get_recent_messages(conversation_id, limit=10),
        "current_lesson": get_current_lesson(user_id, course_id),
        "user_progress": get_user_progress(user_id, course_id)
    }
    return context
```

### Message History Format

```
[
    {"role": "user", "content": "Python lÃ  gÃ¬?"},
    {"role": "assistant", "content": "Python lÃ  má»™t ngÃ´n ngá»¯ láº­p trÃ¬nh..."},
    {"role": "user", "content": "Táº¡i sao nÃªn há»c Python?"},
    ...
]
```

---

## âš¡ Performance Optimization

### Caching Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CACHING RULES                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Common Questions Cache                                     â”‚
â”‚     â”œâ”€â”€ Key: hash(question + course_id)                        â”‚
â”‚     â”œâ”€â”€ TTL: 1 hour                                            â”‚
â”‚     â””â”€â”€ Purpose: Reduce API calls for common questions         â”‚
â”‚                                                                 â”‚
â”‚  2. Course Context Cache                                       â”‚
â”‚     â”œâ”€â”€ Key: course_context:{course_id}                        â”‚
â”‚     â”œâ”€â”€ TTL: 24 hours                                          â”‚
â”‚     â””â”€â”€ Purpose: Speed up context building                     â”‚
â”‚                                                                 â”‚
â”‚  3. Rate Limit Counter                                         â”‚
â”‚     â”œâ”€â”€ Key: rate_limit:{user_id}                              â”‚
â”‚     â”œâ”€â”€ TTL: 1 hour                                            â”‚
â”‚     â””â”€â”€ Purpose: Track API usage                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Response Streaming

```python
async def stream_response(message: str, context: dict):
    async for chunk in claude_client.messages.stream(
        model="claude-3-sonnet",
        messages=[{"role": "user", "content": message}],
        system=build_system_prompt(context)
    ):
        yield chunk.delta.text
```

---

## ğŸ›¡ï¸ Rate Limiting

### Limits

| User Type | Messages/Hour | Messages/Day |
|-----------|---------------|--------------|
| Free | 20 | 100 |
| Premium | 100 | 500 |

### Implementation

```python
async def check_rate_limit(user_id: int):
    key = f"chat_rate:{user_id}"
    count = await redis.incr(key)

    if count == 1:
        await redis.expire(key, 3600)  # 1 hour

    if count > MAX_MESSAGES_PER_HOUR:
        raise HTTPException(
            status_code=429,
            detail="Rate limit exceeded. Try again later."
        )
```

---

## ğŸ“Š Monitoring

### Metrics to Track

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AI METRICS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Usage Metrics:                                                 â”‚
â”‚  â”œâ”€â”€ Total messages per day                                     â”‚
â”‚  â”œâ”€â”€ Messages per user                                          â”‚
â”‚  â”œâ”€â”€ Peak usage hours                                           â”‚
â”‚  â””â”€â”€ Average conversation length                                â”‚
â”‚                                                                 â”‚
â”‚  Performance Metrics:                                           â”‚
â”‚  â”œâ”€â”€ Response time (p50, p95, p99)                              â”‚
â”‚  â”œâ”€â”€ Token usage per message                                    â”‚
â”‚  â”œâ”€â”€ Cache hit rate                                             â”‚
â”‚  â””â”€â”€ Error rate                                                 â”‚
â”‚                                                                 â”‚
â”‚  Quality Metrics:                                               â”‚
â”‚  â”œâ”€â”€ User feedback (thumbs up/down)                             â”‚
â”‚  â”œâ”€â”€ Follow-up questions (indicates unclear answer)             â”‚
â”‚  â””â”€â”€ Topic coverage                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Error Handling

### Common Errors

| Error | Code | Action |
|-------|------|--------|
| API Timeout | 504 | Retry with fallback |
| Rate Limited | 429 | Return cached or queue |
| Invalid Response | 500 | Log and retry |
| Context Too Long | 400 | Summarize history |

### Fallback Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FALLBACK FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Primary (Claude) â”€â”€â–¶ Error â”€â”€â–¶ Fallback (OpenAI) â”€â”€â–¶ Error
                                                            â”‚
                                                            â–¼
                                                    Cached Response
                                                            â”‚
                                                            â–¼
                                                     Generic Message
```

---

## ğŸ’° Cost Optimization

### Token Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TOKEN OPTIMIZATION                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. Limit Context Size                                         â”‚
â”‚     â”œâ”€â”€ Max 10 recent messages                                 â”‚
â”‚     â””â”€â”€ Summarize old conversations                            â”‚
â”‚                                                                 â”‚
â”‚  2. Use Cheaper Models When Possible                           â”‚
â”‚     â”œâ”€â”€ Simple Q&A â†’ Claude Haiku                              â”‚
â”‚     â””â”€â”€ Complex tutoring â†’ Claude Sonnet                       â”‚
â”‚                                                                 â”‚
â”‚  3. Cache Common Responses                                     â”‚
â”‚     â””â”€â”€ Reduce API calls for FAQ                               â”‚
â”‚                                                                 â”‚
â”‚  4. Monitor Usage                                              â”‚
â”‚     â””â”€â”€ Alert when approaching budget                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*TÃ i liá»‡u nÃ y Ä‘á»‹nh nghÄ©a tÃ­ch há»£p AI Chat cho há»‡ thá»‘ng.*
