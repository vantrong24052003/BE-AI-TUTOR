# BE AI TUTOR - Authentication & Authorization

> Chi tiáº¿t vá» authentication vÃ  authorization trong há»‡ thá»‘ng

---

## ğŸ” Authentication

### JWT Token Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         JWT TOKEN                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Header:                                                        â”‚
â”‚  {                                                              â”‚
â”‚    "alg": "HS256",                                              â”‚
â”‚    "typ": "JWT"                                                 â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  Payload:                                                       â”‚
â”‚  {                                                              â”‚
â”‚    "sub": "user_id",                                            â”‚
â”‚    "email": "user@example.com",                                 â”‚
â”‚    "role": "student",                                           â”‚
â”‚    "exp": 1709047200,                                           â”‚
â”‚    "iat": 1709045400                                            â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  Signature:                                                     â”‚
â”‚  HMACSHA256(base64(header) + "." + base64(payload), secret)    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Types

| Token | Lifetime | Purpose |
|-------|----------|---------|
| Access Token | 30 minutes | API authentication |
| Refresh Token | 7 days | Get new access token |

### Token Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TOKEN FLOW                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Login  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Access  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  API    â”‚
  â”‚         â”‚         â”‚ Token   â”‚         â”‚ Request â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â”‚                   â”‚ Expired
       â–¼                   â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Refresh â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  New    â”‚
  â”‚ Token   â”‚         â”‚ Access  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ Token   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Password Requirements

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PASSWORD RULES                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  âœ… Minimum 8 characters                                        â”‚
â”‚  âœ… At least 1 uppercase letter                                 â”‚
â”‚  âœ… At least 1 lowercase letter                                 â”‚
â”‚  âœ… At least 1 number                                           â”‚
â”‚  âœ… At least 1 special character                                â”‚
â”‚  âŒ No common passwords                                         â”‚
â”‚  âŒ No personal information                                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ Authorization

### Roles

| Role | Code | Description |
|------|------|-------------|
| Student | `student` | Há»c viÃªn |
| Teacher | `teacher` | GiÃ¡o viÃªn |
| Admin | `admin` | Quáº£n trá»‹ viÃªn |

### Role Hierarchy

```
admin > teacher > student
```

### Permission Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PERMISSION MATRIX                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                          STUDENT    TEACHER    ADMIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VIEW_COURSES                 âœ…         âœ…         âœ…
CREATE_COURSE                âŒ         âœ…         âœ…
UPDATE_COURSE                âŒ       Owner       âœ…
DELETE_COURSE                âŒ       Owner       âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VIEW_LESSONS                 âœ…         âœ…         âœ…
CREATE_LESSON                âŒ       Owner       âœ…
UPDATE_LESSON                âŒ       Owner       âœ…
DELETE_LESSON                âŒ       Owner       âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VIEW_QUIZ                    âœ…         âœ…         âœ…
CREATE_QUIZ                  âŒ       Owner       âœ…
SUBMIT_QUIZ                  âœ…         âœ…         âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CHAT_WITH_AI                 âœ…         âœ…         âœ…
VIEW_OWN_PROGRESS            âœ…         âœ…         âœ…
VIEW_STUDENT_PROGRESS        âŒ         âœ…         âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MANAGE_USERS                 âŒ         âŒ         âœ…
VIEW_ALL_DATA                âŒ         âŒ         âœ…
SYSTEM_CONFIG                âŒ         âŒ         âœ…
```

### Owner Check

```python
# Course ownership
if course.teacher_id != current_user.id and current_user.role != "admin":
    raise HTTPException(status_code=403, detail="Not authorized")
```

---

## ğŸ”’ Security Measures

### 1. Rate Limiting

| Endpoint | Limit | Window |
|----------|-------|--------|
| /api/auth/login | 5 | 1 minute |
| /api/auth/register | 3 | 1 hour |
| /api/chat/*/messages | 20 | 1 hour |
| Default | 100 | 1 minute |

### 2. Token Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TOKEN STORAGE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Client Side:                                                   â”‚
â”‚  â”œâ”€â”€ Access Token: localStorage (short-lived)                   â”‚
â”‚  â””â”€â”€ Refresh Token: httpOnly cookie (secure)                    â”‚
â”‚                                                                 â”‚
â”‚  Server Side:                                                   â”‚
â”‚  â”œâ”€â”€ Blacklisted tokens in Redis                                â”‚
â”‚  â””â”€â”€ TTL = token expiry time                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Session Management

- One active session per user (configurable)
- Logout invalidates refresh token
- Password change invalidates all tokens

### 4. Security Headers

```python
# Response headers
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000
```

---

## ğŸ”„ Auth Flows

### Registration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input  â”‚â”€â”€â”€â”€â–¶â”‚Validate â”‚â”€â”€â”€â”€â–¶â”‚  Hash   â”‚â”€â”€â”€â”€â–¶â”‚  Save   â”‚
â”‚  Data   â”‚     â”‚  Data   â”‚     â”‚Password â”‚     â”‚  User   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚ Return  â”‚
                                                â”‚  User   â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Login Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input  â”‚â”€â”€â”€â”€â–¶â”‚  Find   â”‚â”€â”€â”€â”€â–¶â”‚ Verify  â”‚â”€â”€â”€â”€â–¶â”‚Generate â”‚
â”‚  Data   â”‚     â”‚  User   â”‚     â”‚Password â”‚     â”‚ Tokens  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚ Return  â”‚
                                                â”‚ Tokens  â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Refresh   â”‚â”€â”€â”€â”€â–¶â”‚   Verify    â”‚â”€â”€â”€â”€â–¶â”‚   Generate  â”‚
â”‚   Token     â”‚     â”‚   Token     â”‚     â”‚ New Access  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ Invalid
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Reject    â”‚
                    â”‚   Request   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Protected Routes

### Dependency Pattern

```python
from fastapi import Depends, HTTPException
from src.core.security import decode_token

async def get_current_user(token: str = Depends(oauth2_scheme)):
    payload = decode_token(token)
    if not payload:
        raise HTTPException(status_code=401, detail="Invalid token")
    return await get_user(payload["sub"])

async def require_role(roles: list[str], user = Depends(get_current_user)):
    if user.role not in roles:
        raise HTTPException(status_code=403, detail="Not authorized")
    return user
```

### Usage Examples

```python
# Any authenticated user
@router.get("/courses")
async def list_courses(user = Depends(get_current_user)):
    ...

# Teacher only
@router.post("/courses")
async def create_course(user = Depends(require_role(["teacher", "admin"]))):
    ...

# Admin only
@router.delete("/users/{id}")
async def delete_user(user = Depends(require_role(["admin"]))):
    ...
```

---

## ğŸ“ Error Responses

| Status | Error | Description |
|--------|-------|-------------|
| 401 | `invalid_token` | Token khÃ´ng há»£p lá»‡ |
| 401 | `token_expired` | Token Ä‘Ã£ háº¿t háº¡n |
| 401 | `invalid_credentials` | Email/password sai |
| 403 | `not_authorized` | KhÃ´ng cÃ³ quyá»n |
| 403 | `account_disabled` | TÃ i khoáº£n bá»‹ khÃ³a |
| 422 | `validation_error` | Dá»¯ liá»‡u khÃ´ng há»£p lá»‡ |

---

*TÃ i liá»‡u nÃ y Ä‘á»‹nh nghÄ©a authentication vÃ  authorization cho há»‡ thá»‘ng.*
